## 部署和管理指南
### [部署]()
- [系统要求]()
	- [支持的平台]()
	- [软件要求]()
- [集群安装]()
- [单机开发环境安装]()
### [管理]()
- [部署设计]()
	- [多机器需求]()
	- [单机器需求]()
- [准备]()
- [注意事项：ZooKeeper的优点和局限性]()
- [实施]()
- [管理]()
	- [当前使用目录清理]()
	- [调试信息清理]()
- [监管]()
- [监控]()
- [日志]()
- [检测]()
- [配置参数]()
	- [最小化配置]()
	- [高级配置]()
	- [集群操作]()
	- [认证和授权]()
	- [试验性选项和特性]()
	- [非安全操作]()
	- [使用Netty框架通信]()
- [ZooKeeper命令]()
- [数据文件管理]()
	- [数据目录]()
	- [日志目录]()
	- [文件管理]()
- [避免事项]()
- [最佳实践]()
 ---

### 部署
本章包含ZooKeeper部署信息和一些几个主题：

- [系统需求]()
- [集群安装]()
- [单机开发安装]()

头两节介绍ZooKeeper生成环境安装例如数据中心，最后一节介绍最基本有限的评估、测试、或开发，但不是生产环境。

### 系统要求
支持的平台

- GNU/Linux 可以作为开发和生产环境支持服务端和客户端
- Sun Solaris 可以作为开发和生产环境支持服务端和客户端
- FreeBSD 只可以作为开发和生产环境支持客户端，Java NIO会无效
- Win32 只能作为开发环境支持服务端和客户端
- MacOSX 只能作为开发环境支持服务端和客户端

软件要求
ZooKeeper运行在JDK6或更高版本上。三个ZooKeeper Server是推荐的最小集群，同时推荐将集群的每个Server部署在隔离的机器上。在雅虎，ZooKeeper经常部署在定制的RHEL上，其为双核处理器，2GB RAM和 80GB IDE硬盘的。

### 群集安装
为了ZooKeeper服务可靠性，你应该部署一个群集整体。只要群集中有大部分工作，就可以提供服务。推荐最好部署服务的数量为奇数。例如，4台机器直营处理单台设备故障，如果2台设备故障，群集将不会重新选举，如果是5台设备将可以处理2台故障的情况。

以下是群集安装步骤，每台设备上都要进行如下操作：

- 1.安装JDK，你可以使用机器自带的JDK，或者从下面链接下载：[http://java.sun.com/javase/downloads/index.jsp](http://java.sun.com/javase/downloads/index.jsp)
- 2.设置Java堆大小，这个对于避免内存交换非常重要，这样严重影响ZooKeeper性能，要确定正确的值，请使用负载测试，并确保您的使用范围很好，这将导致您的交换。保守推荐使用3G或4G的的机器。
- 3.安装ZooKeeper Server，可以从以下链接下载：[http://zookeeper.apache.org/releases.html ](http://zookeeper.apache.org/releases.html )
- 4.创建配置文件，配置文件可以是任何名字，开始你可以用以下信息配置： 
      
		tickTime=200
		dataDir=/var/lib/zookeeper/
		clientPort=2181
		initLimit=5
		syncLimit=2
		server.1=zoo1:2888:3888
		server.2=zoo2:2888:3888
		server.3=zoo3:2888:3888
你可以在[配置参数]()中找到这些配置参数的含义，以下是部分内容：
	
	群集中的服务器要相互知道对方的存在，你可以通过**serverid=host:port:port**这一系列的形式完成。参数**host**和**port**是想对应的。你把服务器ID每台机器创建一个文件命名为一个，每一个服务器，它驻留在服务器的数据目录，如配置文件中指定的参数datadir。
- 5.myid一个文件是由一行只包含机器的ID，所以服务器1个文本将包含文本“1”或者别的什么。身份必须是独一无二的，在合奏，应该有一个值在1和255之间。
- 6.文件配置好后你可以启动ZooKeeper Server
		
		$ java -cp zookeeper.jar:lib/slf4j-api-1.6.1.jar:lib/slf4j-log4j12-1.6.1.jar:lib/log4j-1.2.15.jar:conf \ org.apache.zookeeper.server.quorum.QuorumPeerMain zoo.cfg 
QuorumPeerMain 启动ZooKeeper Server,[JMX](http://java.sun.com/javase/technologies/core/mntr-mgmt/javamanagement/)管理同时被注册，这将以下通过JMX管理工具进行管理。[ZooKeeper JMX文档]()描述了使用JMX管理的细节信息。
- 7.连接到主机上测试部署
	- 用Java你可以运行以下命令来执行简单操作
	- 使用C，你可以编译单线程或多线程操作程序：下面是单线程客户端：
	
		$ make cli_st

		下面是多线程客户端：

		$ make cli_mt
	
	运行任一程序给你一个Shell，在其中执行简单的文件系统，想连用多线程客户端连接到Server可以向如下操作：

	$ cli_mt 127.0.0.1:2181

### 单机开发环境安装
如果你想安装ZooKeeper作为开发环境，你可能需要安装一个ZooKeeper服务器实例，然后安装任何Java或C客户端库和绑定在你的开发机器。

建立一个单一的服务器实例的步骤是类似于上面的，除了配置文件是简单的。你可以信息在[ZooKeeper入门指导]()中的[安装和运行ZooKeeper到单一服务模式]()小节中找到。

关于安装客户端库的信息，参阅管理员程序员指南绑定部分。

### 实施
本章包含运行和管理ZooKeeper信息和一下主题：

- [ZooKeeper部署设计]()
- [预防]()
- [注意事项：ZooKeeper优点和限制]()
- [实施]()
- [管理]()	
- []()
- [监控]()
- [日志]()	
- [调试]()
- [配置参数]()
- [ZooKeeper命令]()
- [数据文件管理]()
- [避免事项]()
- [最佳实践]()

### [ZooKeeper部署设计]()
ZooKeeper的可靠性取决于两个基本假设。
- 1.只有少数部署的server失败的情况，在这种情况下失败意味着一个机器崩溃，或在网络中的一些错误发送在群集中。
- 2.正确的部署机器，正确操作指正确执行代码，要有正确地工作的时钟，并有执行一致的存储和网络组件。

接下来的部分以最大限度的认为这些假设的成立下讨论。一些事夸机器的考虑，另外考虑你部署的每一台机器。

跨机器要求

当ZooKeeper服务被激活，必须有大部分为失败的机器可以互相交流。创建一个运行F个机器失败的群集，你赢部署2*F+1个机器，。因此一个3个机器部署的机器可以处理1个机器失败的请，部署5台机器的群集可以处理2台机器失败的情况。注意不是一个6台机器的群集只能处理2台失败的情况，因此ZooKeeper的部署经常使用的是奇数台机器。

为了获得更好的容错请你应该尽量是机器的失败相互独立（）比如大多数机器共享同一台交换机，交换机的故障可能导致想要的服务都down掉，同样包括同样拥有共享电源电路、冷却系统等。

单机器要求

如果ZooKeeper要与其他应用竞争访问资源例如存储，CPU，网络或者是内存等，其性能将受到明显的影响。ZooKeeper具有较强的耐久性保证，这意味着它使用存储介质来记录更改前的操作，负责该更改是允许完成的。你应该意识到这种依赖，并采取杰出的护理如果你想确保Zookeeper操作不被你们的媒体举行了。以下是你可以采取的措施减少这种情况：
- ZooKeeper的事务日志必须在专用设备。（单独的分区还是不够的）ZooKeeper顺序的写入日志信息，不回与其他处理工序log设备反过来会造成多秒的延迟。
- 不要讲ZooKeeper放到一个交换内存的环境。为了让管理员功能与任何形式的时效性，它不应该被内存交换。因此尽量保证堆大小不超过真实内存的大小。更多信息看[避免事项]()。

### 预防
**避免事项**

**实施管理**

**维护**

ZooKeeper群集不需要长期的维护，但要注意以下事项：

当前应用数据清理

ZooKeeper数据目录保存的是一个群集中存储的znodes的副本。包括快照和事务日志文件。如果znodes反射改变这些改变将追加到事务日志中。偶尔当日志文件增长很大，一个所有当前znodes的状态将被写入文件系统。此快照取代所有以前的日志。

ZooKeeper Server在使用默认配置是不会自动移除快照和日志文件，这是对经营者的责任。每一个服务的环境是不同的，因此，管理这些文件的要求可能会有所不同。

The PurgeTxnLog utility实现了一个简单的保留策略，管理员可以使用。该API文档包含调用约定的细节（论据，等..）。

在下面的例子中，最后的计数快照及其相应的日志被保留，其他被删除。“计数”的值通常大于3（虽然不需要，这在不可能的事件中提供3个备份，最近的日志已损坏）。这可以作为对ZooKeeper服务器一个cron作业清理日志每日。
	
	ava -cp zookeeper.jar:lib/slf4j-api-1.6.1.jar:lib/slf4j-log4j12-1.6.1.jar:lib/log4j-1.2.15.jar:conf org.apache.zookeeper.server.PurgeTxnLog <dataDir> <snapDir> -n <count>
自动清除快照和日志文件在3.4.0中被引入，通过以下配置参数来启用，**autopurge.snapTetainCount**和**autopuutge.purgeInterval**，更多信息看[高级配置]()。

Debug日志清理（log4j）

查看此篇文档的[日志]()部分。预计你会设置一个滚动文件附加使用内置的log4j的特征。在释放焦油的conf/ log4j.properties示例配置文件提供了这样的一个例子。

### 监管
你也行想使用一个健康程序来管理每一个ZooKeeper程序(JVM).ZK server 被设计成为快速失败的，这意味着它将关闭（进程退出），如果发生错误，它不能恢复。作为一个ZooKeeper服务集群是高度可靠的，这意味着服务器可能走集群作为一个整体仍然活跃和服务请求。此外，由于集群是“自愈”失败的服务器重启之后会自动加入集合W / O任何人工交互。

有一个监管程序如[daemontools]()或者[SMF]()（监理过程中的其他选项也可以，这是你要使用哪一个，这只是两个例子）管理你的ZooKeeper服务器确保如果过程是否出现异常会自动重新启动。

### 监测
ZooKeeper服务可以有两种主要方式监测；1）命令端口通过4个字母的单词和使用2）[JMX]()根据想要的环境/需要查看想要的帮助信息。

### 日志
ZooKeeper使用log4j 1.2作为其日志基础，ZooKeeper默认log4j.properties文件放在conf目录下。Log4j要求log4j.properties要么在工作目录（目录由管理员运行）或可从中。

### 故障发现与检修

服务因文件损坏不能启动

- Server因事务日志文件损坏不能读取而无法启动。你可以看一下在加载ZooKeeper数据库是的IO异常。在这种情况下请确认你的群集中的其他Server都能够启动工作。在命令端口用*stat*命令查看，如果他可以使用。在你确定群集中的其他Server可以启动，你可以到前面去订立掉损坏文件的server的数据文件。删除在
目录 *datadir/version-2*和*datalogdir/version2/*下的所有文件。重启Server。

### 配置参数
ZooKeeper的行为有ZooKeeper的配置文件决定。这个文件是这样设计的，完全相同的文件可以被所有的服务器组成ZooKeeper服务器假设磁盘布局是相同的使用。如果Server使用不同的配置文件请确保其内容相匹配。

最小配置

最小化配置下在配置文件中必须配置如下3个参数：

**clientPort** - 端口监听客户端连接，即客户端尝试连接的端口。

**dataDir** - ZooKeeper将存储内存中的数据库快照位置，除非另有规定，更新到数据库的事务日志
>**注意** 你要小心将事务日志放到哪里。专用的事务日志设备是一致的良好性能的关键。将日志放在繁忙的设备上，会对性能产生不利的影响。

**tickTime** - 心跳间隔时间，ZooKeeper使用的最基本的单位，其单位是毫秒。其用于控制心跳时间，和超时。比如最小的session超时时间为两倍的ticks。

高级配置

本节中的配置设置是可选的。你可以用它们来进一步微调您的ZooKeeper服务器的行为。有些还可以设置使用Java系统属性，一般的形式zookeeper.keyword。系统的精确性。

**dataLogDir** - （非Java系统属性） 此选项将决定Server将事务日志信息吓到**dataLogDir**中而不是**dataDir**中。这允许一个专用登录器被使用，并有助于避免测井和简讯之间的竞争。
>**注意** 专用的日志设备的吞吐量和稳定的延迟有很大的影响。它是高度推荐为登录器和集datalogdir指在该设备上的一个目录，然后确定点datadir到目录没有居住在该设备上。

**globalOutstandingLimit** - （Java系统属性：**zookeeper.globalOutstandingLimit.**）客户端能够比ZOoKeeper处理更快的提交请求，特别是有多客户端的情况下。为了避免ZooKeeper因请求对了而内存溢出，ZooKeeper将控制客户端数量不超过此参数设置，默认的限制是1000。

**preAllocSize** - （Java系统属性：**zookeeper.preAllocSize**）为了避免寻求管理员分配的空间在交易中preallocsize字节块的日志文件。缺省的块大小为64M。改变块的大小的一个原因是如果快照是更经常减少块大小。

**snapCount** - （Java系统属性：**zookeeper.snapCount**）ZooKeeper将事务记录到事务日志中，当*snapCount*事务写到日志文件后，将产生一个快照，然后创建新的事务日志，默认的snmpCount 是100，000.

**traceFile** - （Java系统属性：**requestTraceFile**）如果定义此选项，请求将会被记录到traceFile.year.month.day中。使用此参数可以提供有用的debug信息，单一影响性能（注意：这个系统属性没有zookeeper前缀，变量名也不同于系统属性，这确实是不一致的-没说明为什么）。

**maxClientCnxns** - （非Java系统属性）限制单个客户端（socket级别）的并发数，通过IP来标示，这个用来防止特定的Dos攻击和文件描述符的用尽。默认是60，设置为0则会移除并发连接限制。

**clientPortAddress** - （**New in 3.3.0**）监听客户端连接的地址（ipv4，ipv6或者hostname）即客户端尝试连接到的地址。这是可选的，默认情况下我们将在这样一种方式，任何地址/接口/网卡的服务器上的clientport连接任何将被接受。

**minSessionTimeout** - （非Java系统属性**New in 3.3.0**）最小会话超时以毫秒为单位，服务器将允许客户端进行协商。默认值为2倍的ticktime。

**maxSessionTimeout** - （非Java系统属性**New in 3.3.0**）最大会话超时以毫秒为单位，服务器将允许客户端进行协商。默认值为20倍的ticktime。

**fsync.warningthresholdms** - （Java 系统属性：**fsync.warningthresholdms**）-（**New in3.3.4**）一个警告信息将被输出到日志时，在事务日志fsync（沃尔玛）以超过该值。该值是以毫秒为单位，默认为1000。这个值只能被设置为系统属性。

**autopurge.snapRetainCount** - （非Java系统属性**New in 3.4.0**）启用时，动物园管理员自动清洗功能保留autopurge.snapretaincount最近的快照和相应的事务日志分别在datadir和datalogdir并删除其余的。默认为3。最小值为3。

**autopurge.purgeInterval** - （非Java系统属性**New in 3.4.0**）被触发任务所触发的时间间隔。设置为正整数（1和以上），使自动清洗。默认为0。

**syncEnabled** - （Java系统属性：**zookeeper.observer.syncenabled**）(**New in 3.4.6, 3.5.0**)
观察员现在登录事务，并将快照写入磁盘，默认情况下，如参与者。这减少了恢复时间的观察员重新启动。设置为“假”来禁用此功能。默认是“true”.
			
### 群集选项

下面的选项是群集中引用到的：

electionAlg - （非Java系统属性）选举执行使用。值“0”对应的版本的原始UDP，“1”对应于非认证的基于UDP协议的版本快领导人选举，“2”对应于基于UDP的认证版本快领导人的选举，当前默认为3
>**注意** Leader选举的0，1和2的实现，现在已经废弃。我们去他们的下一个版本的意图，在这一点上，只有fastleaderelection将可。

**initLimit**（非Java系统属性）时间，在蜱（见ticktime），让追随者连接和同步到领袖。增加这个值的需要，如果管理员管理的数据量大。

**leaderServes** - (Java系统属性：zookeeper.leaderServes)
领导接受客户关系。默认值是“是”。领导机器坐标更新。在这些微小的牺牲读吞吐量的领袖可以配置为不接受客户和重点协调更高更新的吞吐量。的发.

>**注意** 把领导者选择强烈建议当你有超过三的服务器管理员在合奏。